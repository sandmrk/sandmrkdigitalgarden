{% extends "layouts/base.njk" %}

{% block content %}
<main class="content cm-s-obsidian">
  <header class="tag-page-header">
    <div class="tag-badge">SELECTION</div>
    <h1 style="color: var(--cg-green-vivid) !important; font-size: 2.5rem !important;">
        #<span id="target-tag-name">...</span>
    </h1>
    <p class="tag-subtitle">æ­£åœ¨ä¸ºæ‚¨èšåˆç›¸å…³çµæ„Ÿä¸æç¤ºè¯</p>
    <a href="/" class="back-link">â† è¿”å›ç”»å»Šä¸»é¡µ</a>
  </header>

  <div class="grid-view vertical-mode" id="tag-results-container">
    <div id="loading-spinner">
      <div class="spinner"></div>
      <p>æ­£åœ¨ä»æ˜Ÿè¾°ä¸­æ±²å–åˆ›æ„...</p>
    </div>
  </div>

  <div id="cgfan-comments" style="margin-top:50px">
    <hr style="border:none;border-top:1px dashed #e8f5e9;margin-bottom:30px">
    <div id="waline"></div>
  </div>
</main>

<style>
  /* --- å¼ºåˆ¶å‚ç›´æ¨¡å¼æ ·å¼ --- */
  .vertical-mode table {
    display: flex !important;
    flex-direction: column !important;
    gap: 20px !important;
    max-width: 800px !important;
    margin: 0 auto !important;
    border: none !important;
  }
  .vertical-mode table tbody { display: contents !important; }
  
  .vertical-mode table tr {
    display: flex !important;
    flex-direction: row !important; /* å›¾å·¦æ–‡å³ */
    height: 180px !important;
    background: #fff !important;
    border: 1px solid rgba(0,0,0,0.06) !important;
    border-radius: 16px !important;
    overflow: hidden !important;
    margin-bottom: 10px !important;
    transition: transform 0.2s ease !important;
  }
  
  .vertical-mode table tr:hover {
    transform: translateX(10px) !important;
    border-color: var(--cg-green-vivid) !important;
  }

  .vertical-mode td:first-child {
    width: 280px !important;
    height: 180px !important;
    flex-shrink: 0;
    padding: 0 !important;
  }
  
  .vertical-mode td:first-child img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
  }

  .vertical-mode td:nth-child(2) {
    padding: 24px !important;
    display: flex !important;
    flex-direction: column !important;
    justify-content: center !important;
    border: none !important;
  }

  /* éšè—ä¸éœ€è¦çš„å…ƒæ•°æ®åˆ— */
  .vertical-mode td:nth-child(3), 
  .vertical-mode td:nth-child(4), 
  .vertical-mode td:last-child {
    display: none !important;
  }

  .tag-page-header { text-align: center; padding: 40px 0; }
  .tag-badge {
    display: inline-block; padding: 4px 12px; background: #e8f5e9;
    color: #4caf50; border-radius: 20px; font-size: 12px; font-weight: bold;
  }
  .spinner {
    width: 30px; height: 30px; border: 3px solid #e8f5e9;
    border-top: 3px solid #4caf50; border-radius: 50%;
    margin: 0 auto 10px; animation: spin 1s linear infinite;
  }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  
  @media (max-width: 600px) {
    .vertical-mode table tr { flex-direction: column !important; height: auto !important; }
    .vertical-mode td:first-child { width: 100% !important; height: 160px !important; }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const tag = new URLSearchParams(window.location.search).get('tag');
    if (!tag) return;
    document.getElementById('target-tag-name').innerText = tag;

    const container = document.getElementById('tag-results-container');

    // ä¼˜å…ˆå°è¯•ä» LocalStorage è¯»å–ï¼ˆé¦–é¡µéœ€å·²é…ç½®å­˜å…¥é€»è¾‘ï¼‰
    const cachedData = localStorage.getItem('cgfan_gallery_data');
    
    if (cachedData) {
        renderFromCache(JSON.parse(cachedData), tag);
    } else {
        // å¦‚æœæ²¡ç¼“å­˜ï¼Œå°è¯•ä»é¦–é¡µ fetch
        fetchAndRender(tag);
    }

    function renderFromCache(data, targetTag) {
        let html = "";
        const filtered = data.filter(p => p.tags.includes(targetTag));
        if (filtered.length > 0) {
            filtered.forEach(p => {
                const img = p.cover.includes('twimg.com') ? `https://images.weserv.nl/?url=${encodeURIComponent(p.cover)}` : p.cover;
                html += `<tr style="display:flex !important">
                    <td><img src="${img}"></td>
                    <td>
                        <a href="/notes/${p.path.split('/').pop().replace('.md','')}/" style="font-weight:bold;font-size:1.1rem;text-decoration:none;color:#2d3748;">${p.title}</a>
                        <div style="font-size:0.8rem;color:#5e6c84;margin-top:8px;">ğŸ‘¤ ${p.author} | ğŸ“… ${p.created}</div>
                    </td>
                </tr>`;
            });
            container.innerHTML = `<table><tbody>${html}</tbody></table>`;
        } else {
            container.innerHTML = "æœªæ‰¾åˆ°ç›¸å…³å†…å®¹";
        }
    }

    async function fetchAndRender(targetTag) {
        try {
            const resp = await fetch('/');
            const text = await resp.text();
            const doc = new DOMParser().parseFromString(text, 'text/html');
            const rows = doc.querySelectorAll('.grid-view table tbody tr');
            const listBody = document.createElement('tbody');
            let found = 0;

            rows.forEach(row => {
                if (row.innerText.includes('#' + targetTag)) {
                    const clone = row.cloneNode(true);
                    clone.style.display = 'flex';
                    listBody.appendChild(clone);
                    found++;
                }
            });

            if (found > 0) {
                const table = document.createElement('table');
                table.appendChild(listBody);
                container.innerHTML = '';
                container.appendChild(table);
            } else {
                container.innerHTML = "æœªæ‰¾åˆ°å†…å®¹";
            }
        } catch (e) {
            container.innerHTML = "åŠ è½½å¤±è´¥";
        }
    }
});
</script>
{% endblock %}
